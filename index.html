<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ç”œèœœå®¶åº­ â€” å°èªç¹ªæœ¬</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&family=Noto+Sans+TC:wght@300;400;500&display=swap');

  :root {
    --cream: #fdf6ee;
    --warm-brown: #8b5e3c;
    --soft-red: #c0392b;
    --blush: #f4a7a0;
    --dark: #2c1810;
    --line-green: #06C755;
    --shadow: rgba(139, 94, 60, 0.15);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    background: var(--cream);
    font-family: 'Noto Sans TC', sans-serif;
    min-height: 100vh;
    min-height: 100dvh;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow: hidden;
    position: relative;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      radial-gradient(ellipse at 20% 20%, rgba(244,167,160,0.12) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 80%, rgba(139,94,60,0.08) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }

  /* â”€â”€ é ‚éƒ¨æ¨™é¡Œåˆ— â”€â”€ */
  .top-bar {
    width: 100%;
    max-width: 480px;
    padding: 12px 16px 8px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    position: relative;
    z-index: 10;
  }

  .book-title {
    font-family: 'Noto Serif TC', serif;
    font-weight: 900;
    font-size: 17px;
    color: var(--warm-brown);
    letter-spacing: 2px;
    flex: 1;
  }

  .page-counter {
    font-size: 12px;
    color: var(--warm-brown);
    opacity: 0.65;
    font-weight: 500;
    letter-spacing: 0.5px;
    white-space: nowrap;
  }

  /* â”€â”€ è¿”å› LINE æŒ‰éˆ• â”€â”€ */
  .btn-line-back {
    display: flex;
    align-items: center;
    gap: 5px;
    background: var(--line-green);
    color: white;
    border: none;
    border-radius: 20px;
    padding: 6px 12px;
    font-size: 12px;
    font-weight: 500;
    font-family: 'Noto Sans TC', sans-serif;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(6,199,85,0.3);
    white-space: nowrap;
    flex-shrink: 0;
  }

  .btn-line-back:active { transform: scale(0.93); }

  .btn-line-back svg {
    width: 14px;
    height: 14px;
    fill: white;
    flex-shrink: 0;
  }

  /* â”€â”€ é€²åº¦æ¢ â”€â”€ */
  .progress-wrap {
    width: 100%;
    max-width: 480px;
    padding: 0 20px 18px;
    position: relative;
    z-index: 10;
  }

  .progress-track {
    width: 100%;
    height: 4px;
    background: rgba(139,94,60,0.15);
    border-radius: 99px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--blush), var(--soft-red));
    border-radius: 99px;
    transition: width 0.4s cubic-bezier(0.4,0,0.2,1);
    width: 0%;
  }

  .milestones {
    display: flex;
    justify-content: space-between;
    margin-top: 6px;
    padding: 0 2px;
  }

  .milestone-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: rgba(139,94,60,0.2);
    transition: background 0.3s;
    position: relative;
  }

  .milestone-dot.reached { background: var(--soft-red); }

  .milestone-dot::after {
    content: attr(data-label);
    position: absolute;
    bottom: -16px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 9px;
    color: var(--warm-brown);
    opacity: 0.6;
    white-space: nowrap;
  }

  /* â”€â”€ æ›¸æœ¬ â”€â”€ */
  .book-container {
    width: 100%;
    max-width: 480px;
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 0 16px;
    position: relative;
    z-index: 5;
  }

  .page-frame {
    width: 100%;
    position: relative;
    border-radius: 16px;
    overflow: hidden;
    box-shadow:
      0 2px 4px var(--shadow),
      0 8px 24px var(--shadow),
      0 24px 48px rgba(139,94,60,0.1);
    background: white;
    aspect-ratio: 3/4;
    max-height: calc(100dvh - 190px);
  }

  .page-frame img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: opacity 0.25s ease;
  }

  .page-frame img.loading { opacity: 0; }

  .nav-overlay {
    position: absolute;
    inset: 0;
    display: flex;
  }

  .nav-prev, .nav-next {
    flex: 1;
    cursor: pointer;
    display: flex;
    align-items: center;
    padding: 0 12px;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .nav-prev { justify-content: flex-start; }
  .nav-next { justify-content: flex-end; }
  .page-frame:hover .nav-prev,
  .page-frame:hover .nav-next { opacity: 1; }

  .nav-arrow {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(255,255,255,0.9);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 12px rgba(0,0,0,0.15);
    color: var(--warm-brown);
    font-size: 16px;
    transition: transform 0.15s;
  }

  .nav-arrow:active { transform: scale(0.9); }

  .cover-badge {
    position: absolute;
    top: 12px;
    right: 12px;
    background: var(--soft-red);
    color: white;
    font-size: 10px;
    padding: 4px 10px;
    border-radius: 99px;
    letter-spacing: 1px;
    font-weight: 500;
  }

  .swipe-hint {
    position: absolute;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 11px;
    color: rgba(139,94,60,0.5);
    letter-spacing: 1px;
    pointer-events: none;
    animation: fadeHint 3s forwards 1.5s;
    opacity: 0;
  }

  @keyframes fadeHint {
    0%   { opacity: 0; }
    20%  { opacity: 1; }
    80%  { opacity: 1; }
    100% { opacity: 0; }
  }

  /* â”€â”€ åº•éƒ¨æŒ‰éˆ• â”€â”€ */
  .bottom-nav {
    width: 100%;
    max-width: 480px;
    padding: 12px 20px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    position: relative;
    z-index: 10;
  }

  .btn {
    flex: 1;
    height: 48px;
    border: none;
    border-radius: 24px;
    font-family: 'Noto Sans TC', sans-serif;
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 1px;
  }

  .btn:active { transform: scale(0.96); }

  .btn-prev {
    background: rgba(139,94,60,0.1);
    color: var(--warm-brown);
    flex: 0 0 80px;
  }

  .btn-next {
    background: linear-gradient(135deg, var(--blush), var(--soft-red));
    color: white;
    box-shadow: 0 4px 16px rgba(192,57,43,0.3);
  }

  .btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }

  /* â”€â”€ å„²å­˜æç¤º â”€â”€ */
  .save-indicator {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 10px;
    color: var(--warm-brown);
    opacity: 0;
    transition: opacity 0.3s;
    z-index: 50;
    letter-spacing: 0.5px;
    pointer-events: none;
  }
  .save-indicator.show { opacity: 0.45; }

  /* â”€â”€ Toast â”€â”€ */
  .toast {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--dark);
    color: white;
    padding: 12px 24px;
    border-radius: 99px;
    font-size: 14px;
    font-weight: 500;
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.4,0,0.2,1);
    pointer-events: none;
    z-index: 100;
    white-space: nowrap;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* â”€â”€ ç¹¼çºŒé–±è®€å°è©±æ¡† â”€â”€ */
  .resume-overlay {
    position: fixed;
    inset: 0;
    background: rgba(44,24,16,0.6);
    backdrop-filter: blur(6px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 300;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
    padding: 24px;
  }
  .resume-overlay.show { opacity: 1; pointer-events: all; }

  .resume-card {
    background: var(--cream);
    border-radius: 24px;
    padding: 32px 28px;
    width: 100%;
    max-width: 340px;
    text-align: center;
    box-shadow: 0 24px 64px rgba(0,0,0,0.3);
  }

  .resume-emoji { font-size: 48px; margin-bottom: 12px; }

  .resume-title {
    font-family: 'Noto Serif TC', serif;
    font-size: 20px;
    font-weight: 900;
    color: var(--dark);
    margin-bottom: 8px;
    letter-spacing: 2px;
  }

  .resume-desc {
    font-size: 14px;
    color: var(--warm-brown);
    margin-bottom: 12px;
    line-height: 1.6;
  }

  .resume-page-badge {
    display: inline-block;
    background: var(--soft-red);
    color: white;
    padding: 4px 16px;
    border-radius: 99px;
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 24px;
  }

  .resume-btns { display: flex; flex-direction: column; gap: 10px; }

  .btn-resume {
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: 16px;
    font-family: 'Noto Sans TC', sans-serif;
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    letter-spacing: 1px;
    transition: all 0.2s;
  }
  .btn-resume:active { transform: scale(0.97); }
  .btn-resume-continue {
    background: linear-gradient(135deg, var(--blush), var(--soft-red));
    color: white;
    box-shadow: 0 4px 16px rgba(192,57,43,0.25);
  }
  .btn-resume-restart {
    background: rgba(139,94,60,0.1);
    color: var(--warm-brown);
  }

  /* â”€â”€ å®Œæˆæ…¶ç¥ â”€â”€ */
  .complete-overlay {
    position: fixed;
    inset: 0;
    background: rgba(253,246,238,0.97);
    backdrop-filter: blur(8px);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 200;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s;
    padding: 24px;
  }
  .complete-overlay.show { opacity: 1; pointer-events: all; }

  .complete-emoji {
    font-size: 72px;
    margin-bottom: 16px;
    animation: bounceIn 0.8s cubic-bezier(0.4,0,0.2,1) forwards;
  }

  @keyframes bounceIn {
    0%   { transform: scale(0) rotate(-10deg); }
    60%  { transform: scale(1.2) rotate(5deg); }
    100% { transform: scale(1) rotate(0deg); }
  }

  .complete-title {
    font-family: 'Noto Serif TC', serif;
    font-size: 28px;
    font-weight: 900;
    color: var(--dark);
    margin-bottom: 8px;
    letter-spacing: 3px;
  }

  .complete-subtitle {
    font-size: 15px;
    color: var(--warm-brown);
    margin-bottom: 8px;
    letter-spacing: 1px;
  }

  .complete-stats {
    font-size: 13px;
    color: rgba(139,94,60,0.6);
    margin-bottom: 28px;
  }

  .complete-btns {
    display: flex;
    flex-direction: column;
    gap: 10px;
    width: 100%;
    max-width: 280px;
  }

  .btn-close-complete {
    padding: 14px 48px;
    background: linear-gradient(135deg, var(--blush), var(--soft-red));
    color: white;
    border: none;
    border-radius: 99px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    box-shadow: 0 8px 24px rgba(192,57,43,0.3);
    letter-spacing: 2px;
    font-family: 'Noto Sans TC', sans-serif;
    width: 100%;
    transition: all 0.2s;
  }

  .btn-back-line-complete {
    padding: 14px;
    background: var(--line-green);
    color: white;
    border: none;
    border-radius: 99px;
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    font-family: 'Noto Sans TC', sans-serif;
    letter-spacing: 1px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    box-shadow: 0 4px 16px rgba(6,199,85,0.3);
    transition: all 0.2s;
  }

  .btn-back-line-complete svg {
    width: 16px; height: 16px; fill: white;
  }

  .btn-close-complete:active,
  .btn-back-line-complete:active { transform: scale(0.96); }
</style>
</head>
<body>

<!-- é ‚éƒ¨æ¨™é¡Œåˆ— -->
<div class="top-bar">
  <div class="book-title">ç”œèœœå®¶åº­</div>
  <div class="page-counter" id="pageCounter">å°é¢</div>
  <button class="btn-line-back" onclick="goBackToLine()">
    <!-- LINE icon -->
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.281.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/>
    </svg>
    è¿”å› LINE
  </button>
</div>

<!-- é€²åº¦æ¢ -->
<div class="progress-wrap">
  <div class="progress-track">
    <div class="progress-fill" id="progressFill"></div>
  </div>
  <div class="milestones">
    <div class="milestone-dot" data-page="0"  data-label="é–‹å§‹"></div>
    <div class="milestone-dot" data-page="10" data-label="p10"></div>
    <div class="milestone-dot" data-page="20" data-label="p20"></div>
    <div class="milestone-dot" data-page="30" data-label="p30"></div>
    <div class="milestone-dot" data-page="36" data-label="å®Œæˆ"></div>
  </div>
</div>

<!-- æ›¸æœ¬ -->
<div class="book-container">
  <div class="page-frame" id="pageFrame">
    <img id="pageImg" src="images/page-00.jpg" alt="å°é¢" draggable="false">
    <div class="nav-overlay">
      <div class="nav-prev" onclick="prevPage()"><div class="nav-arrow">â€¹</div></div>
      <div class="nav-next" onclick="nextPage()"><div class="nav-arrow">â€º</div></div>
    </div>
    <div class="cover-badge" id="coverBadge">å°èªç¹ªæœ¬</div>
    <div class="swipe-hint">â† æ»‘å‹•ç¿»é  â†’</div>
  </div>
</div>

<!-- åº•éƒ¨æŒ‰éˆ• -->
<div class="bottom-nav">
  <button class="btn btn-prev" id="btnPrev" onclick="prevPage()" disabled>ä¸Šä¸€é </button>
  <button class="btn btn-next" id="btnNext" onclick="nextPage()">ä¸‹ä¸€é  â†’</button>
</div>

<div class="save-indicator" id="saveIndicator">âœ“ å·²å„²å­˜é€²åº¦</div>
<div class="toast" id="toast"></div>

<!-- ç¹¼çºŒé–±è®€å°è©±æ¡† -->
<div class="resume-overlay" id="resumeOverlay">
  <div class="resume-card">
    <div class="resume-emoji">ğŸ“–</div>
    <div class="resume-title">ç¹¼çºŒè®€çŸ£ï¼</div>
    <div class="resume-desc">ä¸Šæ¬¡è®€åˆ°</div>
    <div class="resume-page-badge" id="resumePageBadge">ç¬¬ X é </div>
    <div class="resume-btns">
      <button class="btn-resume btn-resume-continue" onclick="resumeReading()">ç¹¼çºŒè®€ï¼ˆå¾ä¸Šæ¬¡ï¼‰</button>
      <button class="btn-resume btn-resume-restart"  onclick="restartReading()">å¾é ­é–‹å§‹</button>
    </div>
  </div>
</div>

<!-- å®Œæˆæ…¶ç¥ -->
<div class="complete-overlay" id="completeOverlay">
  <div class="complete-emoji">ğŸ‰</div>
  <div class="complete-title">è®€å®ŒçŸ£ï¼</div>
  <div class="complete-subtitle">æ­å–œä½ çœ‹å®Œã€Šç”œèœœå®¶åº­ã€‹</div>
  <div class="complete-stats" id="completeStats"></div>
  <div class="complete-btns">
    <button class="btn-close-complete" onclick="closeComplete()">å†è®€ä¸€æ¬¡</button>
    <button class="btn-back-line-complete" onclick="goBackToLine()">
      <svg viewBox="0 0 24 24"><path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.281.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/></svg>
      è¿”å› LINE Bot
    </button>
  </div>
</div>

<script>
// ============================================================
// â˜… è¨­å®šå€
// ============================================================
const CONFIG = {
  TOTAL_PAGES   : 37,
  BOOK_ID       : 'sweet-family',
  IMAGE_BASE    : 'images/',
  GAS_API_URL   : 'YOUR_GAS_WEBHOOK_URL_HERE',
  LINE_BOT_URL  : 'https://line.me/R/ti/p/@509ymzdy',
  SAVE_INTERVAL : 5,
  MILESTONES    : [10, 20, 30],
};

// ============================================================
// URL åƒæ•¸
// ============================================================
const urlParams = new URLSearchParams(window.location.search);
const userId    = urlParams.get('uid')  || 'anonymous';
const bookId    = urlParams.get('book') || CONFIG.BOOK_ID;
const STORE_KEY = `reading_${userId}_${bookId}`;

// ============================================================
// ç‹€æ…‹
// ============================================================
let state = {};

// ============================================================
// åˆå§‹åŒ–
// ============================================================
function init() {
  const saved = loadLocal();

  if (saved && saved.maxReached > 0 && !saved.isCompleted) {
    state = {
      currentPage        : 0,
      maxReached         : saved.maxReached,
      reportedMilestones : saved.reportedMilestones || [],
      startTime          : new Date().toISOString(),
      firstOpenTime      : saved.firstOpenTime || saved.startTime,
      isCompleted        : false,
    };
    showResumeDialog(saved.maxReached);
  } else {
    resetState(saved);
  }

  updateUI();
  setupSwipe();
  setupKeyboard();
  setupLeaveDetection();
}

// ============================================================
// é‡ç½®
// ============================================================
function resetState(saved) {
  state = {
    currentPage        : 0,
    maxReached         : 0,
    reportedMilestones : [],
    startTime          : new Date().toISOString(),
    firstOpenTime      : saved?.firstOpenTime || new Date().toISOString(),
    isCompleted        : false,
  };
}

// ============================================================
// localStorage
// ============================================================
function saveLocal() {
  try {
    localStorage.setItem(STORE_KEY, JSON.stringify({
      ...state,
      savedAt: new Date().toISOString(),
    }));
  } catch(e) {}
}

function loadLocal() {
  try {
    const raw = localStorage.getItem(STORE_KEY);
    return raw ? JSON.parse(raw) : null;
  } catch(e) { return null; }
}

// ============================================================
// è¿”å› LINE Bot
// ============================================================
function goBackToLine() {
  // å…ˆå„²å­˜é€²åº¦ä¸¦å›å‚³ pause
  saveLocal();
  if (!state.isCompleted && state.currentPage > 0) {
    reportToGAS('pause', state.currentPage);
  }
  // çŸ­æš«å»¶é²ç¢ºä¿ fetch é€å‡ºå¾Œå†è·³è½‰
  setTimeout(() => {
    window.location.href = CONFIG.LINE_BOT_URL;
  }, 300);
}

// ============================================================
// ç¹¼çºŒé–±è®€
// ============================================================
function showResumeDialog(lastPage) {
  const label = lastPage === 0 ? 'å°é¢' : `ç¬¬ ${lastPage} é `;
  document.getElementById('resumePageBadge').textContent = label;
  document.getElementById('resumeOverlay').classList.add('show');
}

function resumeReading() {
  document.getElementById('resumeOverlay').classList.remove('show');
  state.currentPage = state.maxReached;
  updateUI();
  showToast(`ğŸ“– ç¹¼çºŒå¾ç¬¬ ${state.maxReached} é è®€èµ·`);
}

function restartReading() {
  document.getElementById('resumeOverlay').classList.remove('show');
  const firstOpen = state.firstOpenTime;
  resetState({ firstOpenTime: firstOpen });
  updateUI();
}

// ============================================================
// ç•«é¢æ›´æ–°
// ============================================================
function updateUI() {
  const total  = CONFIG.TOTAL_PAGES - 1;
  const pg     = state.currentPage;
  const pageNo = String(pg).padStart(2, '0');
  const img    = document.getElementById('pageImg');

  img.classList.add('loading');
  const tmp = new Image();
  tmp.onload = tmp.onerror = () => {
    img.src = `${CONFIG.IMAGE_BASE}page-${pageNo}.jpg`;
    img.classList.remove('loading');
  };
  tmp.src = `${CONFIG.IMAGE_BASE}page-${pageNo}.jpg`;

  const counter = document.getElementById('pageCounter');
  if (pg === 0)          counter.textContent = 'å°é¢';
  else if (pg === total) counter.textContent = 'æœ€å¾Œä¸€é ';
  else                   counter.textContent = `ç¬¬ ${pg} é  / ${total}`;

  document.getElementById('progressFill').style.width =
    ((pg / total) * 100) + '%';

  document.querySelectorAll('.milestone-dot').forEach(dot => {
    dot.classList.toggle('reached', pg >= parseInt(dot.dataset.page));
  });

  document.getElementById('btnPrev').disabled = pg === 0;
  const btnNext = document.getElementById('btnNext');
  btnNext.disabled    = pg === total;
  btnNext.textContent = pg === total ? 'è®€å®ŒçŸ£ âœ“' : 'ä¸‹ä¸€é  â†’';

  document.getElementById('coverBadge').style.display =
    pg === 0 ? 'block' : 'none';
}

// ============================================================
// ç¿»é 
// ============================================================
function nextPage() {
  const total = CONFIG.TOTAL_PAGES - 1;
  if (state.currentPage >= total) return;

  state.currentPage++;
  updateUI();

  if (state.currentPage > state.maxReached) {
    state.maxReached = state.currentPage;
  }

  checkMilestone(state.currentPage);

  if (state.currentPage % CONFIG.SAVE_INTERVAL === 0) {
    autoSave('progress');
  }

  if (state.currentPage === total) {
    state.isCompleted = true;
    autoSave('complete');
    saveLocal();
    setTimeout(() => showComplete(), 600);
  } else {
    saveLocal();
  }
}

function prevPage() {
  if (state.currentPage <= 0) return;
  state.currentPage--;
  updateUI();
  saveLocal();
}

// ============================================================
// é‡Œç¨‹ç¢‘
// ============================================================
function checkMilestone(page) {
  CONFIG.MILESTONES.forEach(m => {
    if (page >= m && !state.reportedMilestones.includes(m)) {
      state.reportedMilestones.push(m);
      reportToGAS('milestone', m);
      showToast(`ğŸŠ è®€åˆ°ç¬¬ ${m} é çŸ£ï¼`);
    }
  });
}

// ============================================================
// é›¢é–‹åµæ¸¬
// ============================================================
function setupLeaveDetection() {
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      saveLocal();
      if (!state.isCompleted && state.currentPage > 0) {
        reportToGAS('pause', state.currentPage);
      }
    }
  });

  window.addEventListener('beforeunload', () => { saveLocal(); });

  window.addEventListener('pagehide', () => {
    saveLocal();
    if (!state.isCompleted && state.currentPage > 0) {
      reportToGAS('pause', state.currentPage);
    }
  });
}

// ============================================================
// è‡ªå‹•å„²å­˜
// ============================================================
function autoSave(type) {
  saveLocal();
  reportToGAS(type, state.currentPage);
  const ind = document.getElementById('saveIndicator');
  ind.classList.add('show');
  setTimeout(() => ind.classList.remove('show'), 1500);
}

// ============================================================
// å›å‚³ GAS
// Sheet æ¬„ä½ï¼šuid | bookId | type | page | maxReached
//             | totalPages | startTime | firstOpenTime | timestamp
// ============================================================
function reportToGAS(type, page) {
  const url = CONFIG.GAS_API_URL;
  if (!url || url === 'YOUR_GAS_WEBHOOK_URL_HERE') return;
  if (userId === 'anonymous') return;

  fetch(url, {
    method  : 'POST',
    mode    : 'no-cors',
    headers : { 'Content-Type': 'application/json' },
    body    : JSON.stringify({
      uid           : userId,
      bookId        : bookId,
      type          : type,
      page          : page,
      maxReached    : state.maxReached,
      totalPages    : CONFIG.TOTAL_PAGES - 1,
      startTime     : state.startTime,
      firstOpenTime : state.firstOpenTime,
      timestamp     : new Date().toISOString(),
    }),
  }).catch(() => {});
}

// ============================================================
// Toast
// ============================================================
let toastTimer = null;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
}

// ============================================================
// å®Œæˆæµ®å±¤
// ============================================================
function showComplete() {
  document.getElementById('completeStats').textContent =
    `å…± ${CONFIG.TOTAL_PAGES - 1} é å…¨éƒ¨è®€å®ŒçŸ£ ğŸŒŸ`;
  document.getElementById('completeOverlay').classList.add('show');
}

function closeComplete() {
  document.getElementById('completeOverlay').classList.remove('show');
  // é‡ç½®è®“ä»–å¯ä»¥å†è®€ä¸€æ¬¡
  const firstOpen = state.firstOpenTime;
  resetState({ firstOpenTime: firstOpen });
  updateUI();
}

// ============================================================
// æ‰‹å‹¢æ»‘å‹•
// ============================================================
function setupSwipe() {
  let sx = 0, sy = 0;
  const frame = document.getElementById('pageFrame');

  frame.addEventListener('touchstart', e => {
    sx = e.touches[0].clientX;
    sy = e.touches[0].clientY;
  }, { passive: true });

  frame.addEventListener('touchend', e => {
    const dx = e.changedTouches[0].clientX - sx;
    const dy = e.changedTouches[0].clientY - sy;
    if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 40) {
      dx < 0 ? nextPage() : prevPage();
    }
  }, { passive: true });
}

// ============================================================
// éµç›¤
// ============================================================
function setupKeyboard() {
  document.addEventListener('keydown', e => {
    if (e.key === 'ArrowRight' || e.key === 'ArrowDown') nextPage();
    if (e.key === 'ArrowLeft'  || e.key === 'ArrowUp')   prevPage();
  });
}

// ============================================================
// å•Ÿå‹•
// ============================================================
init();
</script>
</body>
</html>
